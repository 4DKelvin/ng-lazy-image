angular.module("afkl.lazyImage",[]).service("afklSrcSetService",["$window","$document",function(a,b){"use strict";function c(a){this.src=a.src,this.w=a.w||1/0,this.h=a.h||1/0,this.x=a.x||1}var d=/^[0-9]+$/,e=function(a){for(var b=a.split(/\s/),c={},e=0,f=b.length;f>e;e++){var g=b[e];if(g.length>0){var h=g.slice(-1),i=g.substring(0,g.length-1),j=parseInt(i,10),k=parseFloat(i);i.match(d)&&"w"===h?c[h]=j:i.match(d)&&"h"===h?c[h]=j:isNaN(k)||"x"!==h||(c[h]=k)}}return c},f=function(a,b){for(var c=a[0],d=0,e=a.length;e>d;d++){var f=a[d];b(f,c)&&(c=f)}return c},g=function(a,b){for(var c=a.length-1;c>=0;c--){var d=a[c];b(d)&&a.splice(c,1)}return a},h=function(c,d){if(c){d||(d={w:a.innerWidth||b[0].documentElement.clientWidth,h:a.innerHeight||b[0].documentElement.clientHeight,x:a.devicePixelRatio||1});var e=c.slice(0),h=f(e,function(a,b){return a.w>b.w});g(e,function(){return function(a){return a.w<d.w}}(this)),0===e.length&&(e=[h]);var i=f(e,function(a,b){return a.h>b.h});g(e,function(){return function(a){return a.h<d.h}}(this)),0===e.length&&(e=[i]);var j=f(e,function(a,b){return a.x>b.x});g(e,function(){return function(a){return a.x<d.x}}(this)),0===e.length&&(e=[j]);var k=f(e,function(a,b){return a.w<b.w});g(e,function(a){return a.w>k.w});var l=f(e,function(a,b){return a.h<b.h});g(e,function(a){return a.h>l.h});var m=f(e,function(a,b){return a.x<b.x});return g(e,function(a){return a.x>m.x}),e[0]}},i=function(a){var b=[],d=a.src,f=a.srcset;if(f){var g=function(a){for(var c=0,d=b.length;d>c;c++){var e=b[c];if(e.x===a.x&&e.w===a.w&&e.h===a.h)return}b.push(a)},i=function(){for(var a,b,h=f,i=0,j=[];""!==h;){for(;" "===h.charAt(0);)h=h.slice(1);i=h.indexOf(" "),-1!==i?(a=h.slice(0,i),h=h.slice(i+1),i=h.indexOf(","),-1===i?(b=h,h=""):(b=h.slice(0,i),h=h.slice(i+1)),j.push({url:a,descriptors:b})):(j.push({url:h,descriptors:""}),h="")}for(var k=0,l=j.length;l>k;k++){var m=j[k],n=e(m.descriptors);g(new c({src:m.url,x:n.x,w:n.w,h:n.h}))}d&&g(new c({src:d}))};i();var j=h(b),k={best:j,candidates:b};return b=null,k}};return{get:i,image:h}}]).directive("afklLazyImage",["$window","$document","$timeout","afklSrcSetService",function(a,b,c,d){"use strict";var e=function(a){var b,c=d.get({srcset:a});return c&&(b=c.best.src),b};return{restrict:"A",link:function(d,f,g){a=angular.element(a);var h,i,j,k=!1,l=g.afklLazyImage,m=g.afklLazyImageOptions?angular.fromJson(g.afklLazyImageOptions):{},n=null,o=m.offset?m.offset:50,p="afkl-lazy-image-loading",q=function(){j=f[0].getBoundingClientRect().top},r=function(){m.background?f[0].style.backgroundImage='url("'+n+'")':i[0].src=n},s=function(){if(k){var a=e(l);a!==n&&(n=a,r())}else q()};s();var t=function(){f.removeClass(p)},u=function(){var c,d,g,h="innerHeight"in a[0]?a[0].innerHeight:b[0].documentElement.clientHeight,q="scrollY"in a[0]?a[0].scrollY:document[0].documentElement.scrollTop;g=h+q,c=j-g,d=o>=c,d&&!k&&(k=!0,n=e(l),n&&(m.background||(f.addClass(p),i=angular.element('<img alt="" class="afkl-lazy-image" src=""/>'),i.one("load",t),f.append(i)),r()),a.off("scroll",u))},v=function(){c.cancel(h),h=c(s,300)},w=function(){c.cancel(h),a.off("scroll",u),a.off("resize",v),i&&i.remove(),i=h=j=n=void 0};return a.on("scroll",u),a.on("resize",v),d.$on("$destroy",function(){return w()}),u()}}}]);